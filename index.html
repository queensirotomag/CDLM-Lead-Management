<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Centralized Digital Lead Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
  <style>
    :root {
      --bg-body: #050816;
      --bg-header: #050816;
      --bg-sidebar: #0b1020;
      --bg-card: #0f172a;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --accent: #6366f1;
      --accent-soft: rgba(99, 102, 241, 0.15);
      --accent-strong: #4f46e5;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      font-size: 13px;
    }

    .login-page {
      width: 100%; height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #020617 100%);
    }
    .login-container {
      width: 100%; max-width: 420px;
      padding: 40px 32px 32px;
      background: radial-gradient(circle at top left, #111827, #020617 60%);
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }
    .login-header { text-align: center; margin-bottom: 28px; }
    .login-title {
      font-size: 22px; font-weight: 700;
      color: var(--text-main); margin-bottom: 4px;
    }
    .login-form { display: flex; flex-direction: column; gap: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 12px; font-weight: 600; color: var(--text-muted); }
    .form-group input {
      padding: 11px 12px;
      background: #020617;
      border: 1px solid rgba(55, 65, 81, 0.9);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 13px;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .login-btn {
      margin-top: 6px;
      padding: 11px;
      width: 100%;
      background: linear-gradient(135deg, var(--accent-strong), #22c55e);
      border: none;
      border-radius: 8px;
      color: #020617;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .login-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
    }
    .login-footer {
      margin-top: 20px;
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
      border-top: 1px solid rgba(31, 41, 55, 0.6);
      padding-top: 10px;
    }

    .app-shell { display: grid; grid-template-rows: 60px 1fr; width: 100%; height: 100vh; overflow: hidden; }
    .app-shell.hidden { display: none; }
    .app-main { display: grid; grid-template-columns: 280px 1fr; width: 100%; height: 100%; overflow: hidden; }

    .header {
      background: rgba(5, 8, 22, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(55, 65, 81, 0.8);
      padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-logo {
      width: 36px; height: 36px;
      border-radius: 8px;
      background: conic-gradient(from 210deg, #4f46e5, #22c55e, #f59e0b, #4f46e5);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 18px;
      color: #020617;
      flex-shrink: 0;
    }
    .brand-text { font-weight: 600; font-size: 16px; }
    .brand-sub { font-size: 11px; color: var(--text-soft); }
    .header-right { display: flex; gap: 12px; align-items: center; }
    .user-info { font-size: 11px; text-align: right; }
    .user-name { color: var(--text-main); font-weight: 600; }
    .user-role { color: var(--text-soft); font-size: 10px; }
    .header-btn {
      padding: 7px 11px;
      background: rgba(17, 24, 39, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      border-radius: 6px;
      color: var(--text-main);
      cursor: pointer;
      font-size: 11px;
      display: inline-flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .header-btn:hover { background: rgba(55, 65, 81, 0.8); }

    .sidebar {
      padding: 16px 12px;
      background: radial-gradient(circle at top left, #020617, #020617 55%, #020617 100%);
      border-right: 1px solid rgba(31, 41, 55, 0.85);
      overflow-y: auto;
      overflow-x: hidden;
      flex-shrink: 0;
      display: flex; flex-direction: column;
      gap: 20px;
    }
    .sidebar::-webkit-scrollbar { width: 6px; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(55, 65, 81, 0.5); border-radius: 3px; }
    .sidebar-section { flex-shrink: 0; }
    .sidebar-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .nav-item {
      display: flex; align-items: center; gap: 8px;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }
    .nav-item:hover { background: rgba(55, 65, 81, 0.6); color: var(--text-main); }
    .nav-item.active {
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(99, 102, 241, 0.7);
    }
    .file-input-wrapper input[type="file"] { display: none; }
    .file-input-label {
      display: block;
      background: rgba(17, 24, 39, 0.8);
      color: var(--text-main);
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      border: 1px solid rgba(55, 65, 81, 0.9);
      transition: all 0.2s;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .file-input-label:hover { background: rgba(55, 65, 81, 0.8); }
    .btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      gap: 6px;
      transition: all 0.2s;
      margin-bottom: 6px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-strong), #22c55e);
      color: #020617;
    }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: rgba(17, 24, 39, 0.8);
      color: var(--text-main);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }
    .sidebar-stats {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding: 8px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 4px;
    }
    .sidebar-stats strong { color: var(--text-main); font-weight: 700; }
    .assigned-person {
      background: rgba(99, 102, 241, 0.15);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      border: 1px solid rgba(99, 102, 241, 0.3);
    }
    .assigned-person-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
    }
    .assigned-stats {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .stat-item { display: flex; justify-content: space-between; margin-bottom: 2px; }
    .divider { height: 1px; background: rgba(31, 41, 55, 0.5); margin: 0; }

    .mapping-modal {
      display: none;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      align-items: center; justify-content: center;
    }
    .mapping-modal.show { display: flex; }
    .mapping-modal-content {
      background: radial-gradient(circle at top left, #111827, #020617 60%);
      border: 1px solid rgba(31, 41, 55, 0.9);
      border-radius: 12px;
      padding: 20px;
      width: 90%; max-width: 700px; max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }
    .mapping-modal-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.5);
      display: flex; justify-content: space-between; align-items: center;
    }
    .mapping-modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
    }
    .mapping-item {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(31, 41, 55, 0.5);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .mapping-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .mapping-select {
      width: 100%;
      padding: 8px;
      background: #020617;
      border: 1px solid rgba(55, 65, 81, 0.9);
      border-radius: 6px;
      color: var(--text-main);
      font-size: 12px;
    }
    .mapping-hint {
      font-size: 10px;
      color: var(--text-soft);
      margin-top: 4px;
      font-style: italic;
    }
    .mapping-detected {
      display: inline-block;
      background: var(--success);
      color: #020617;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-top: 4px;
    }
    .mapping-actions { display: flex; gap: 8px; margin-top: 20px; }
    .mapping-actions button { flex: 1; }

    .debug-log {
      background: #020617;
      border: 1px solid rgba(31, 41, 55, 0.9);
      border-radius: 4px;
      padding: 8px;
      font-family: "Courier New", monospace;
      font-size: 10px;
      max-height: 120px;
      overflow-y: auto;
    }
    .debug-log::-webkit-scrollbar { width: 4px; }
    .debug-log::-webkit-scrollbar-thumb { background: rgba(55, 65, 81, 0.5); }
    .log-entry { padding: 2px 0; opacity: 0.9; line-height: 1.2; }
    .log-entry.success { color: var(--success); }
    .log-entry.error { color: var(--danger); }
    .log-entry.warning { color: var(--warning); }
    .log-entry.info { color: #60a5fa; }

    .page { padding: 16px; overflow: auto; flex-shrink: 1; }
    .page::-webkit-scrollbar { width: 6px; }
    .page::-webkit-scrollbar-thumb { background: rgba(55, 65, 81, 0.5); border-radius: 3px; }
    .page-header { margin-bottom: 16px; }
    .page-title { font-size: 24px; font-weight: 600; margin-bottom: 2px; }
    .page-subtitle { font-size: 12px; color: var(--text-soft); }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .kpi-card {
      padding: 14px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      border: 1px solid rgba(31, 41, 55, 0.5);
      text-align: center;
    }
    .kpi-number { font-size: 24px; font-weight: 700; }
    .kpi-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    .card {
      background: radial-gradient(circle at top left, #111827, #020617 60%);
      border-radius: 8px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      display: flex; flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .card-header { margin-bottom: 12px; }
    .card-title { font-size: 16px; font-weight: 600; }
    .card-subtitle { font-size: 11px; color: var(--text-soft); margin-top: 2px; }

    .filters-container {
      background: rgba(15, 23, 42, 0.8);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      border: 1px solid rgba(31, 41, 55, 0.7);
    }
    .filters-title { font-size: 12px; font-weight: 600; margin-bottom: 8px; }
    .filters-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }
    .filter-group label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 8px;
      background: #020617;
      border: 1px solid rgba(55, 65, 81, 0.9);
      border-radius: 4px;
      color: var(--text-main);
      font-size: 11px;
    }

    .table-wrapper {
      border-radius: 8px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      overflow: auto;
      flex: 1;
    }
    .table-wrapper::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-wrapper::-webkit-scrollbar-thumb { background: rgba(55, 65, 81, 0.5); border-radius: 3px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead {
      background: linear-gradient(90deg, #111827, #020617);
      position: sticky; top: 0; z-index: 10;
    }
    th {
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      white-space: nowrap;
      font-size: 11px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.6);
    }
    td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.6);
      word-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }
    tbody tr:hover { background: rgba(17, 24, 39, 0.8); }

    select {
      background: #020617;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-main);
      padding: 5px 6px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .btn-danger {
      background: var(--danger);
      color: white;
      padding: 5px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 3px 6px;
      background: var(--accent-soft);
      color: var(--accent);
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-soft);
      font-size: 12px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 12px;
      border-left: 3px solid;
      display: none;
      font-size: 12px;
    }
    .message.show { display: block; animation: slideIn 0.3s ease; }
    .message-success {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
      border-left-color: var(--success);
    }
    .message-error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
      border-left-color: var(--danger);
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @media (max-width: 768px) {
      .app-main { grid-template-columns: 1fr; }
      .sidebar {
        position: fixed;
        left: -280px;
        width: 280px;
        height: 100vh;
        z-index: 100;
        transition: left 0.3s;
      }
      .sidebar.open { left: 0; }
      .header { padding: 0 16px; }
      .hamburger {
        display: block;
        cursor: pointer;
        padding: 8px;
        font-size: 20px;
        color: var(--text-main);
      }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .filters-row { grid-template-columns: 1fr; }
      .page-title { font-size: 20px; }
      table { font-size: 11px; }
      th, td { padding: 8px 4px; }
    }
  </style>
</head>
<body>
  <div class="login-page" id="loginPage">
    <div class="login-container">
      <div class="login-header">
        <div class="login-title">Centralized Digital Lead Management</div>
      </div>
      <form class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="loginUsername" placeholder="Enter username" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password" required>
        </div>
        <button type="submit" class="login-btn">Sign In</button>
      </form>
      <div class="login-footer">
        Demo: admin/admin123 | onkar/onkar123 | goraksha/goraksha123 | sachin/sachin123 | rajesh/rajesh123
      </div>
    </div>
  </div>

  <div class="app-shell hidden" id="appShell">
    <header class="header">
      <div class="brand">
        <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
        <div class="brand-logo">üìä</div>
        <div>
          <div class="brand-text">Centralized Digital Lead Management</div>
          <div class="brand-sub">CDLMs</div>
        </div>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-name" id="headerUsername">User</div>
          <div class="user-role" id="headerUserRole">Team</div>
        </div>
        <button class="header-btn" onclick="handleLogout()">üö™ Logout</button>
      </div>
    </header>

    <main class="app-main">
      <aside class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-title">Dashboard</div>
          <div class="nav-item active"><span>üìä</span><span>Overview</span></div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Firestore Setup</div>
          <input type="password" id="firebaseKey" placeholder="API Key"
                 style="display:block;padding:8px;background:#020617;border:1px solid rgba(55,65,81,0.9);border-radius:4px;color:var(--text-main);font-size:11px;width:100%;margin-bottom:6px;">
          <input type="text" id="firebaseProject" placeholder="Project ID"
                 style="display:block;padding:8px;background:#020617;border:1px solid rgba(55,65,81,0.9);border-radius:4px;color:var(--text-main);font-size:11px;width:100%;margin-bottom:6px;">
          <button class="btn btn-primary" onclick="initFirebase()" style="margin-bottom:6px;">üî• Connect Firebase</button>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Import Data</div>
          <div class="file-input-wrapper">
            <input type="file" id="csvFile" accept=".csv" onchange="handleFileSelect(event)">
            <label for="csvFile" class="file-input-label">üìÅ Select CSV</label>
          </div>
          <button id="processBtn" class="btn btn-primary" onclick="uploadAndParseCSV()" disabled>
            üìã Parse & Map
          </button>
          <button class="btn btn-secondary" onclick="clearImport()">üîÑ Reset</button>
        </div>

        <div class="divider"></div>

        <div class="sidebar-section">
          <div class="sidebar-title">Lead Database</div>
          <div class="sidebar-stats">üìä Total: <strong id="sidebarTotalLeads">0</strong></div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Team Assignment</div>
          <div id="assignedPeopleContainer"></div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Activity Logs</div>
          <div class="debug-log" id="debugLog">
            <div class="log-entry info">[--:--:--] Ready</div>
          </div>
        </div>
      </aside>

      <section class="page">
        <div class="page-header">
          <h1 class="page-title">CDLM Dashboard</h1>
          <p class="page-subtitle">
            Upload CSV / Google Sheet ‚Üí Auto Clean & Segment ‚Üí Manage & Track
         </p>
        </div>

        <div id="messageContainer"></div>

        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-number" id="kpiTotal">0</div>
            <div class="kpi-label">Total Leads</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-number" id="kpiAssigned">0</div>
            <div class="kpi-label">Assigned</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-number" id="kpiQualified">0</div>
            <div class="kpi-label">Qualified</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-number" id="kpiCampaign">0</div>
            <div class="kpi-label">Campaign</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">üìä All Leads</div>
              <div class="card-subtitle">
                Centralized view
              </div>
            </div>
          </div>

          <div class="filters-container">
            <div class="filters-title">üîç Filters</div>
            <div class="filters-row">
              <div class="filter-group">
                <label>Name</label>
                <input type="text" id="searchName" placeholder="Search‚Ä¶" onkeyup="applyFilters()">
              </div>
              <div class="filter-group">
                <label>Segment</label>
                <select id="filterSegment" onchange="applyFilters()">
                  <option value="">All</option>
                  <option value="Pune">Pune</option>
                  <option value="Ahmedabad">Ahmedabad</option>
                  <option value="Bangalore">Bangalore</option>
                  <option value="Maharashtra">Maharashtra</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Assign To</label>
                <select id="filterAssignTo" onchange="applyFilters()">
                  <option value="">All</option>
                  <option value="Onkar">Onkar</option>
                  <option value="Goraksha">Goraksha</option>
                  <option value="Sachin">Sachin</option>
                  <option value="Rajesh">Rajesh</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Status</label>
                <select id="filterStatus" onchange="applyFilters()">
                  <option value="">All</option>
                  <option value="Open Lead">Open Lead</option>
                  <option value="Follow-up">Follow-up</option>
                  <option value="Assigned">Assigned</option>
                  <option value="Qualified">Qualified</option>
                  <option value="Converted">Converted</option>
                </select>
              </div>
              <div style="display:flex;gap:6px;align-items:flex-end;">
                <button class="btn btn-primary" style="margin:0;padding:8px;" onclick="applyFilters()">Filter</button>
                <button class="btn btn-secondary" style="margin:0;padding:8px;" onclick="clearFilters()">Reset</button>
                <button class="btn btn-primary" style="margin:0;padding:8px;" onclick="exportCurrentView()">‚¨á CSV</button>
                <button class="btn btn-primary" style="margin:0;padding:8px;" onclick="syncToFirestore()">‚òÅÔ∏è Sync</button>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <table id="leadsTable">
              <thead>
                <tr>
                  <th>Lead ID</th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Who You Are</th>
                  <th>Products</th>
                  <th>City</th>
                  <th>Segment</th>
                  <th>Assign To</th>
                  <th>Category</th>
                  <th>Reference</th>
                  <th>Status</th>
                  <th>Campaign</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr>
                  <td colspan="14">
                    <div class="empty-state">üìÅ No leads. Upload CSV to start!</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="mapping-modal" id="mappingModal">
    <div class="mapping-modal-content">
      <div class="mapping-modal-header">
        üîó Header Column Mapping
        <button class="mapping-modal-close" onclick="closeMappingModal()">‚úï</button>
      </div>
      <p style="font-size:11px;color:var(--text-soft);margin-bottom:16px;">
        Auto-detected your CSV columns. Adjust if needed before processing.
      </p>
      <div id="mappingFieldsContainer"></div>
      <div class="mapping-actions">
        <button class="btn btn-primary" onclick="confirmAndCleanData()">‚úÖ Confirm & Process</button>
        <button class="btn btn-secondary" onclick="closeMappingModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>

  <script>
    
    const USERS = {
      'admin':   { password: 'admin123',   displayName: 'Admin',   isAdmin: true  },
      'onkar':   { password: 'onkar123',   displayName: 'Onkar',   isAdmin: false },
      'goraksha':{ password: 'goraksha123',displayName: 'Goraksha',isAdmin: false },
      'sachin':  { password: 'sachin123',  displayName: 'Sachin',  isAdmin: false },
      'rajesh':  { password: 'rajesh123',  displayName: 'Rajesh',  isAdmin: false }
    };

    const PRODUCT_ASSIGNMENT = {
      'Solar Pump':       'Onkar',
      'Submersible Pump': 'Goraksha',
      'Energy Storage':   'Sachin',
      'Solar Rooftop':    'Rajesh'
    };

    const CATEGORY_OPTIONS = [
      'Request Call Back',
      'Meet Senior Person',
      'Interested in Quote',
      'Send Product Details',
      'Requesting Demo'
    ];

    const STATUS_OPTIONS = [
      'Open Lead',
      'Follow-up',
      'Assigned',
      'Qualified',
      'Converted'
    ];

    const TEAM_MEMBERS = ['Onkar', 'Goraksha', 'Sachin', 'Rajesh'];

    let currentUser = null;
    const STORAGE_KEY = 'cdlm_leads_v17';
    let allLeads = [];
    let registeredPhones = new Set();
    let db = null;
    let fbInitialized = false;
    let rawCSVData = [];
    let fileHeaders = [];
    let columnMapping = {};
    let currentFilteredLeads = [];

    const COMMON_DOMAINS = [
      'gmail.com','yahoo.com','outlook.com','hotmail.com','live.com',
      'aol.com','icloud.com','proton.me','rediffmail.com','rotomag.com','rotosol.com'
    ];
    const DOMAIN_FIX_MAP = {
      'mail.com':'gmail.com','gmal.com':'gmail.com','gmial.com':'gmail.com',
      'gmail.co':'gmail.com','gmail.con':'gmail.com',
      'yahooo.com':'yahoo.com','yahho.com':'yahoo.com','yaho.com':'yahoo.com',
      'hotmai.com':'hotmail.com','hotmail.co':'hotmail.com',
      'outlok.com':'outlook.com','outlook.co':'outlook.com',
      'proton.com':'proton.me','redifmail.com':'rediffmail.com'
    };

    const dbFieldPatterns = {
      'full_name':   ['name','full name','full_name','first name','customer','exhibitor'],
      'phone_number':['phone','mobile','contact number','phone_number','contact','tel'],
      'email':       ['email','e-mail','mail','email id','email_id'],
      'who_you_are': ['who you are','who_you_are','designation','role','position'],
      'city':        ['city','location','state','region','address'],
      'product':     ['product','interested in','interested_in','solution'],
      'reference':   ['reference','referral','ref by','referred','reference name','who referred']
    };

    function autoDetectColumns(headers) {
      columnMapping = {};
      Object.keys(dbFieldPatterns).forEach(dbField => {
        const patterns = dbFieldPatterns[dbField];
        let matched = null;
        for (const header of headers) {
          const headerLower = header.toLowerCase();
          for (const pattern of patterns) {
            if (headerLower.includes(pattern)) {
              matched = header;
              break;
            }
          }
          if (matched) break;
        }
        columnMapping[dbField] = matched || '';
      });
      return columnMapping;
    }

    function renderMappingModal() {
      const container = document.getElementById('mappingFieldsContainer');
      let html = '';
      Object.keys(dbFieldPatterns).forEach(dbField => {
        const currentMapping = columnMapping[dbField] || '';
        const isDetected = currentMapping !== '';
        html += `
          <div class="mapping-item">
            <div class="mapping-label">
              üîπ ${dbField.toUpperCase()} ${isDetected ? '<span class="mapping-detected">‚úì</span>' : ''}
            </div>
            <select class="mapping-select" id="map_${dbField}">
              <option value="">-- Skip --</option>`;
        fileHeaders.forEach(header => {
          const selected = currentMapping === header ? 'selected' : '';
          html += `<option value="${header}" ${selected}>${header}</option>`;
        });
        html += `</select><div class="mapping-hint">${dbFieldPatterns[dbField].join(', ')}</div></div>`;
      });
      container.innerHTML = html;
    }

    function openMappingModal() {
      renderMappingModal();
      document.getElementById('mappingModal').classList.add('show');
    }

    function closeMappingModal() {
      document.getElementById('mappingModal').classList.remove('show');
    }

    function initFirebase() {
      const apiKey = document.getElementById('firebaseKey').value.trim();
      const projectId = document.getElementById('firebaseProject').value.trim();
      if (!apiKey || !projectId) {
        showMessage('Enter API Key & Project ID', 'error');
        return;
      }
      try {
        const config = {
          apiKey, projectId,
          storageBucket: projectId + '.appspot.com',
          databaseURL: 'https://' + projectId + '.firebaseio.com'
        };
        firebase.initializeApp(config);
        db = firebase.firestore();
        fbInitialized = true;
        addDebugLog('‚úÖ Firebase Connected', 'success');
        showMessage('Firebase Connected!', 'success');
      } catch (err) {
        addDebugLog('‚ùå ' + err.message, 'error');
        showMessage('Error: ' + err.message, 'error');
      }
    }

    function handleLogin(e) {
      e.preventDefault();
      const u = document.getElementById('loginUsername').value.trim();
      const p = document.getElementById('loginPassword').value.trim();
      if (USERS[u] && USERS[u].password === p) {
        currentUser = {
          username: u,
          displayName: USERS[u].displayName,
          isAdmin: USERS[u].isAdmin
        };
        localStorage.setItem('cdlm_current_user', JSON.stringify(currentUser));
        showDashboard();
      } else {
        alert('Invalid credentials');
      }
    }

    function handleLogout() {
      if (!confirm('Logout?')) return;
      currentUser = null;
      localStorage.removeItem('cdlm_current_user');
      document.getElementById('appShell').classList.add('hidden');
      document.getElementById('loginPage').style.display = 'flex';
    }

    function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('appShell').classList.remove('hidden');
      document.getElementById('headerUsername').textContent = currentUser.displayName;
      document.getElementById('headerUserRole').textContent = currentUser.isAdmin ? 'Admin' : 'Team';
      loadData();
      renderTable(allLeads);
      updateMetrics();
      updateAssignedPeopleSection();
      currentFilteredLeads = [...allLeads];
      addDebugLog('‚úÖ Dashboard loaded', 'success');
    }

    function handleFileSelect(e) {
      if (e.target.files[0]) {
        addDebugLog('üìÅ File: ' + e.target.files[0].name, 'info');
        document.getElementById('processBtn').disabled = false;
      }
    }

    function clearImport() {
      document.getElementById('csvFile').value = '';
      document.getElementById('processBtn').disabled = true;
    }

    async function uploadAndParseCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return;
      try {
        addDebugLog('‚è≥ Parsing CSV...', 'info');
        const text = await file.text();
        rawCSVData = parseCSV(text);
        if (rawCSVData.length === 0) {
          showMessage('No data in CSV', 'error');
          return;
        }
        fileHeaders = Object.keys(rawCSVData[0]);
        addDebugLog('üìã ' + rawCSVData.length + ' rows, ' + fileHeaders.length + ' columns', 'info');
        autoDetectColumns(fileHeaders);
        addDebugLog('‚úÖ Auto-detected column mapping', 'success');
        openMappingModal();
      } catch (err) {
        showMessage('Error: ' + err.message, 'error');
        addDebugLog('‚ùå ' + err.message, 'error');
      }
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];
      const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cells = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = cells[idx] ? cells[idx].trim() : '';
        });
        if (Object.values(row).some(v => v !== '')) rows.push(row);
      }
      return rows;
    }

    function parseCSVLine(line) {
      const cells = [];
      let current = '';
      let insideQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"' && line[i + 1] === '"') {
          current += '"';
          i++;
        } else if (char === '"') {
          insideQuotes = !insideQuotes;
        } else if (char === ',' && !insideQuotes) {
          cells.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      cells.push(current);
      return cells;
    }

    function confirmAndCleanData() {
      Object.keys(columnMapping).forEach(dbField => {
        columnMapping[dbField] = document.getElementById('map_' + dbField).value;
      });
      addDebugLog('‚úÖ Mapping confirmed', 'success');
      closeMappingModal();
      processAndCleanData();
    }

    function levenshtein(a, b) {
      const m = a.length, n = b.length;
      const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
        }
      }
      return dp[m][n];
    }

    function bestCommonDomain(d) {
      let best = { domain: d, distance: Infinity };
      for (const known of COMMON_DOMAINS) {
        const dist = levenshtein(d, known);
        if (dist < best.distance) best = { domain: known, distance: dist };
      }
      return best;
    }

    function fixEmailDomain(domainRaw) {
      let d = (domainRaw || '').trim().toLowerCase();
      if (DOMAIN_FIX_MAP[d]) return { domain: DOMAIN_FIX_MAP[d], corrected: true };
      if (!/\.[a-z]{2,}$/.test(d)) {
        const candidate = d + '.com';
        const best = bestCommonDomain(candidate);
        if (best.distance <= 2) return { domain: best.domain, corrected: true };
        return { domain: candidate, corrected: true };
      }
      const best = bestCommonDomain(d);
      if (best.distance <= 2) return { domain: best.domain, corrected: true };
      return { domain: d, corrected: false };
    }

    function normalizeEmail(raw) {
      if (!raw) return { email: '', corrected: false };
      let e = String(raw).trim().replace(/\s+/g, '').toLowerCase();
      e = e.replace(/\(at\)/g, '@').replace(/\[at\]/g, '@');
      if (!e.includes('@')) return { email: '', corrected: false };
      const parts = e.split('@');
      if (parts.length !== 2 || !parts[0]) return { email: '', corrected: false };
      const { domain, corrected } = fixEmailDomain(parts[1]);
      return { email: `${parts[0]}@${domain}`, corrected };
    }

    function cleanPhoneNumber(phone) {
      if (!phone) return null;
      const digits = phone.replace(/\D/g, '');
      if (digits.length < 10) return null;
      const last10 = digits.slice(-10);
      return '+91-' + last10.slice(0,5) + '-' + last10.slice(5);
    }

    function parseProducts(productRaw) {
      if (!productRaw) return [];
      const delimiters = [';', ',', '|'];
      let products = [productRaw];
      for (const delim of delimiters) {
        if (productRaw.includes(delim)) {
          products = productRaw.split(delim).map(p => p.trim()).filter(p => p !== '');
          break;
        }
      }
      return products;
    }

    function determineSegment(city) {
      if (!city) return 'Maharashtra';
      const c = city.toLowerCase();
      if (c.includes('pune') || c.includes('dharashiv')) return 'Pune';
      if (c.includes('ahmedabad') || c.includes('jalgaon')) return 'Ahmedabad';
      if (c.includes('bangalore')) return 'Bangalore';
      return 'Maharashtra';
    }

    function determineAssignmentByProduct(product) {
      if (!product) return 'Onkar';
      for (const [prod, team] of Object.entries(PRODUCT_ASSIGNMENT)) {
        if (product.toLowerCase().includes(prod.toLowerCase())) {
          return team;
        }
      }
      return 'Rajesh';
    }

    function cleanReferenceValue(refRaw) {
      if (refRaw == null) return '-';
      const v = String(refRaw).trim();
      if (v === '') return '-';
      const upper = v.toUpperCase();
      if (upper === '#NA' || upper === '#N/A' || upper === 'NA' || upper === 'N/A') {
        return '-';
      }
      return v;
    }

    function processAndCleanData() {
      const cleaned = [];
      let skipped = 0;

      rawCSVData.forEach(row => {
        const name = row[columnMapping.full_name] || '';
        let phone = row[columnMapping.phone_number] || '';
        const city = row[columnMapping.city] || '';
        const productRaw = row[columnMapping.product] || '';
        const emailRaw = row[columnMapping.email] || '';
        const whoYouAre = row[columnMapping.who_you_are] || '';
        const referenceRaw = columnMapping.reference ? row[columnMapping.reference] || '' : '';

        if (!name || !phone) {
          skipped++;
          return;
        }
        phone = cleanPhoneNumber(phone);
        if (!phone) {
          skipped++;
          return;
        }
        if (registeredPhones.has(phone)) {
          addDebugLog('üö´ Duplicate: ' + phone, 'warning');
          skipped++;
          return;
        }

        registeredPhones.add(phone);
        const emailInfo = normalizeEmail(emailRaw);
        const products = parseProducts(productRaw);
        const primaryProduct = products.length > 0 ? products[0] : 'General';
        if (emailInfo.corrected) {
          addDebugLog('‚úâÔ∏è Email fixed: ' + emailRaw + ' ‚Üí ' + emailInfo.email, 'success');
        }

        const cleanedReference = cleanReferenceValue(referenceRaw);

        cleaned.push({
          full_name: name,
          phone_number: phone,
          email: emailInfo.email,
          who_you_are: whoYouAre,
          product: primaryProduct,
          products_list: products,
          city: city,
          category: '',
          reference: cleanedReference,
          segment: determineSegment(city),
          assign_to: determineAssignmentByProduct(primaryProduct),
          status: 'Open Lead',
          campaign_enabled: 'No',
          date_added: new Date().toISOString().split('T')[0]
        });
      });

      addDebugLog('‚úÖ Cleaned ' + cleaned.length + ' leads (Default: Open Lead)', 'success');
      if (skipped > 0) addDebugLog('‚ö†Ô∏è Skipped ' + skipped, 'warning');
      addLeadsToDatabase(cleaned);
      renderTable(allLeads);
      updateMetrics();
      updateAssignedPeopleSection();
      currentFilteredLeads = [...allLeads];
      showMessage('‚úÖ Imported ' + cleaned.length + ' leads (Status: Open Lead)', 'success');
      clearImport();
    }

    function addLeadsToDatabase(leads) {
      leads.forEach((l, idx) => {
        const leadId = 'LEAD-' + String(allLeads.length + idx + 1).padStart(4, '0');
        allLeads.push({ lead_id: leadId, ...l });
      });
      saveData();
    }

    function loadData() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        allLeads = stored ? JSON.parse(stored) : [];
        allLeads.forEach(l => registeredPhones.add(l.phone_number));
        addDebugLog('üìÇ Loaded ' + allLeads.length + ' leads', 'success');
      } catch (e) {
        allLeads = [];
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allLeads));
      } catch (e) {
        addDebugLog('Save error', 'error');
      }
    }

    async function syncToFirestore() {
      if (!fbInitialized || !db) {
        showMessage('Connect Firebase first', 'error');
        return;
      }
      if (allLeads.length === 0) {
        showMessage('No leads to sync', 'error');
        return;
      }
      try {
        addDebugLog('‚è≥ Syncing...', 'info');
        const batch = db.batch();
        const leadsRef = db.collection('leads');
        allLeads.forEach(lead => {
          const docRef = leadsRef.doc(lead.lead_id);
          batch.set(docRef, {
            ...lead,
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            sync_time: new Date().toISOString()
          });
        });
        await batch.commit();
        addDebugLog('‚úÖ Synced ' + allLeads.length + ' leads', 'success');
        showMessage('‚úÖ Synced to Firestore!', 'success');
      } catch (err) {
        addDebugLog('‚ùå ' + err.message, 'error');
        showMessage('Sync error: ' + err.message, 'error');
      }
    }

    function renderTable(leads) {
      const tb = document.getElementById('tableBody');
      if (!leads.length) {
        tb.innerHTML = '<tr><td colspan="14"><div class="empty-state">üìÅ No leads</div></td></tr>';
        return;
      }
      tb.innerHTML = leads.map(l => `
        <tr>
          <td><strong>${l.lead_id}</strong></td>
          <td>${l.full_name}</td>
          <td><span style="font-family:monospace;font-size:10px;">${l.phone_number}</span></td>
          <td>${l.email || '-'}</td>
          <td><span class="badge">${l.who_you_are || '-'}</span></td>
          <td>${l.products_list ? l.products_list.join(' | ') : '-'}</td>
          <td>${l.city || ''}</td>
          <td><span class="badge">${l.segment}</span></td>
          <td>
            <select onchange="updateField('${l.lead_id}','assign_to',this.value)" style="font-size:10px;">
              <option value="Onkar" ${l.assign_to === 'Onkar' ? 'selected':''}>Onkar</option>
              <option value="Goraksha" ${l.assign_to === 'Goraksha' ? 'selected':''}>Goraksha</option>
              <option value="Sachin" ${l.assign_to === 'Sachin' ? 'selected':''}>Sachin</option>
              <option value="Rajesh" ${l.assign_to === 'Rajesh' ? 'selected':''}>Rajesh</option>
            </select>
          </td>
          <td>
            <select onchange="updateField('${l.lead_id}','category',this.value)" style="font-size:10px;">
              <option value="">-- Select Category --</option>
              <option value="Request Call Back" ${l.category === 'Request Call Back' ? 'selected':''}>üìû Request Call Back</option>
              <option value="Meet Senior Person" ${l.category === 'Meet Senior Person' ? 'selected':''}>üë• Meet Senior Person</option>
              <option value="Interested in Quote" ${l.category === 'Interested in Quote' ? 'selected':''}>üí∞ Interested in Quote</option>
              <option value="Send Product Details" ${l.category === 'Send Product Details' ? 'selected':''}>üìÑ Send Product Details</option>
              <option value="Requesting Demo" ${l.category === 'Requesting Demo' ? 'selected':''}>üé¨ Requesting Demo</option>
            </select>
          </td>
          <td style="max-width:150px;">${l.reference || '-'}</td>
          <td>
            <select onchange="updateField('${l.lead_id}','status',this.value)" style="font-size:10px;">
              <option value="Open Lead" ${l.status === 'Open Lead' ? 'selected':''}>üìÇ Open Lead</option>
              <option value="Follow-up" ${l.status === 'Follow-up' ? 'selected':''}>üìû Follow-up</option>
              <option value="Assigned" ${l.status === 'Assigned' ? 'selected':''}>üìå Assigned</option>
              <option value="Qualified" ${l.status === 'Qualified' ? 'selected':''}>‚úÖ Qualified</option>
              <option value="Converted" ${l.status === 'Converted' ? 'selected':''}>üéâ Converted</option>
            </select>
          </td>
          <td>
            <select onchange="updateField('${l.lead_id}','campaign_enabled',this.value)" style="font-size:10px;">
              <option value="No" ${l.campaign_enabled === 'No' ? 'selected':''}>No</option>
              <option value="Yes" ${l.campaign_enabled === 'Yes' ? 'selected':''}>Yes</option>
            </select>
          </td>
          <td>
            <button class="btn-danger" onclick="deleteLead('${l.lead_id}')">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    function updateField(leadId, field, val) {
      const l = allLeads.find(x => x.lead_id === leadId);
      if (l) {
        l[field] = val;
        saveData();
        applyFilters();
        updateMetrics();
        updateAssignedPeopleSection();
        addDebugLog('Updated ' + leadId + ' ‚Üí ' + field, 'success');
      }
    }

    function deleteLead(leadId) {
      if (!confirm('Delete?')) return;
      allLeads = allLeads.filter(x => x.lead_id !== leadId);
      saveData();
      applyFilters();
      updateMetrics();
      updateAssignedPeopleSection();
    }

    function applyFilters() {
      const name = document.getElementById('searchName').value.toLowerCase();
      const seg = document.getElementById('filterSegment').value;
      const assignTo = document.getElementById('filterAssignTo').value;
      const st = document.getElementById('filterStatus').value;

      const filtered = allLeads.filter(l =>
        (name === '' || l.full_name.toLowerCase().includes(name)) &&
        (seg === '' || l.segment === seg) &&
        (assignTo === '' || l.assign_to === assignTo) &&
        (st === '' || l.status === st)
      );
      currentFilteredLeads = filtered;
      renderTable(filtered);
    }

    function clearFilters() {
      document.getElementById('searchName').value = '';
      document.getElementById('filterSegment').value = '';
      document.getElementById('filterAssignTo').value = '';
      document.getElementById('filterStatus').value = '';
      currentFilteredLeads = [...allLeads];
      renderTable(allLeads);
    }

    function updateMetrics() {
      document.getElementById('kpiTotal').textContent = allLeads.length;
      document.getElementById('kpiAssigned').textContent = allLeads.length;
      document.getElementById('kpiQualified').textContent =
        allLeads.filter(l => l.status === 'Qualified' || l.status === 'Converted').length;
      document.getElementById('kpiCampaign').textContent =
        allLeads.filter(l => l.campaign_enabled === 'Yes').length;
      document.getElementById('sidebarTotalLeads').textContent = allLeads.length;
    }

    function updateAssignedPeopleSection() {
      const cont = document.getElementById('assignedPeopleContainer');
      const stats = {};
      TEAM_MEMBERS.forEach(n => stats[n] = { count: 0, qualified: 0 });
      allLeads.forEach(l => {
        if (l.assign_to && stats[l.assign_to]) {
          stats[l.assign_to].count++;
          if (l.status === 'Qualified' || l.status === 'Converted') stats[l.assign_to].qualified++;
        }
      });
      let html = '';
      TEAM_MEMBERS.forEach(n => {
        if (stats[n].count > 0) {
          html += `
            <div class="assigned-person">
              <div class="assigned-person-name">üë§ ${n}</div>
              <div class="assigned-stats">
                <div class="stat-item"><span>Leads:</span><span>${stats[n].count}</span></div>
                <div class="stat-item"><span>Qual:</span><span>${stats[n].qualified}</span></div>
              </div>
            </div>`;
        }
      });
      cont.innerHTML = html || '<div style="font-size:11px;color:var(--text-soft);text-align:center;">No assignments</div>';
    }

    function exportCurrentView() {
      const data = currentFilteredLeads && currentFilteredLeads.length ? currentFilteredLeads : allLeads;
      if (!data.length) {
        showMessage('No data to export', 'error');
        return;
      }
      const headers = [
        'lead_id','full_name','phone_number','email','who_you_are','products_list',
        'city','segment','assign_to','category','reference','status','campaign_enabled','date_added'
      ];
      const csvRows = [];
      csvRows.push(headers.join(','));

      data.forEach(l => {
        const row = [
          l.lead_id || '',
          escapeCSV(l.full_name || ''),
          escapeCSV(l.phone_number || ''),
          escapeCSV(l.email || ''),
          escapeCSV(l.who_you_are || ''),
          escapeCSV((l.products_list || []).join(' | ')),
          escapeCSV(l.city || ''),
          escapeCSV(l.segment || ''),
          escapeCSV(l.assign_to || ''),
          escapeCSV(l.category || ''),
          escapeCSV(l.reference || ''),
          escapeCSV(l.status || ''),
          escapeCSV(l.campaign_enabled || ''),
          escapeCSV(l.date_added || '')
        ];
        csvRows.push(row.join(','));
      });

      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href = url;
      a.download = `cdlm_export_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      addDebugLog('‚¨á Exported ' + data.length + ' rows', 'success');
      showMessage('Exported ' + data.length + ' rows!', 'success');
    }

    function escapeCSV(val) {
      const v = String(val);
      if (/[",\n]/.test(v)) return '"' + v.replace(/"/g, '""') + '"';
      return v;
    }

    function addDebugLog(msg, type = 'info') {
      const box = document.getElementById('debugLog');
      const div = document.createElement('div');
      div.className = 'log-entry ' + type;
      const t = new Date().toLocaleTimeString();
      div.textContent = '[' + t + '] ' + msg;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function showMessage(text, type) {
      const c = document.getElementById('messageContainer');
      const div = document.createElement('div');
      div.className = 'message message-' + type + ' show';
      div.textContent = text;
      c.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedUser = localStorage.getItem('cdlm_current_user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showDashboard();
      }
    });
  </script>
</body>
</html>
